#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# temporal:create <service_name> [db_type] [--db-service=existing_service_name]
temporal:create() {
    local service_name="$1"
    local db_type="${2:-postgres}"
    local db_service=""

    # Parse --db-service option from remaining arguments
    shift 2 2>/dev/null || shift $# 2>/dev/null
    while [[ $# -gt 0 ]]; do
        case $1 in
            --db-service=*)
                db_service="${1#*=}"
                shift
                ;;
            *)
                echo "Error: Unknown option: $1"
                return 1
                ;;
        esac
    done

    debug_log "[temporal:create] Called with service_name='$service_name', db_type='$db_type', db_service='$db_service'"

    if ! validate_service_name "$service_name" "create"; then
        return 1
    fi

    # 1. Check if the Temporal service already exists
    debug_log "[temporal:create] Checking if service '$service_name' exists..."
    if service_exists "$service_name"; then
        local existing_db_type
        existing_db_type=$(service_info_get "$service_name" "DB_TYPE")
        echo "Error: Temporal service '$service_name' already exists (db_type='$existing_db_type')."
        echo "Hint: To re-create, first destroy it using 'dokku temporal:destroy $service_name'"
        return 1
    fi
    debug_log "[temporal:create] Temporal service '$service_name' does not exist. Proceeding."

    # 2. Validate database type and check if plugin is installed
    case "$db_type" in
        postgres|mysql)
            if ! check_db_plugin "$db_type"; then 
                echo "Please install the $db_type plugin first:"
                echo "dokku plugin:install https://github.com/dokku/dokku-$db_type.git $db_type"
                return 1
            fi
            ;;
        *)
            echo "Error: Invalid or unsupported database type '$db_type'. Supported: postgres, mysql."
            return 1
            ;;
    esac
    debug_log "[temporal:create] Database type '$db_type' is valid and its plugin is installed."

    # 3. Create Docker network for Temporal services
    local temporal_docker_network="temporal-network"
    debug_log "[temporal:create] Ensuring Docker network '$temporal_docker_network' exists..."
    if ! docker network inspect "$temporal_docker_network" >/dev/null 2>&1; then
        echo "Info: Creating Docker network '$temporal_docker_network'..."
        if docker network create "$temporal_docker_network"; then
            echo "Docker network '$temporal_docker_network' created successfully."
        else
            echo "Error: Failed to create Docker network '$temporal_docker_network'."
            return 1
        fi
    else
        echo "Info: Docker network '$temporal_docker_network' already exists."
    fi

    # 4. Create or validate underlying Dokku datastore
    local actual_db_service="${db_service:-$service_name}"
    debug_log "[temporal:create] Using database service: '$actual_db_service'"
    
    if [ -n "$db_service" ]; then
        # User specified existing database service - validate it exists
        debug_log "[temporal:create] Validating existing $db_type service '$db_service'..."
        if ! dokku "$db_type:info" "$db_service" >/dev/null 2>&1; then
            echo "Error: Specified database service '$db_service' does not exist."
            echo "Please create it first with: dokku $db_type:create $db_service"
            return 1
        fi
        echo "Info: Using existing $db_type service '$db_service'."
    else
        # Default behavior - create database service with same name as temporal service
        debug_log "[temporal:create] Checking if $db_type service '$service_name' exists..."
        local db_exists=false
        
        # Try multiple ways to check if the service exists
        if dokku "$db_type:exists" "$service_name" 2>/dev/null | grep -q "true"; then
            db_exists=true
        elif dokku "$db_type:info" "$service_name" >/dev/null 2>&1; then
            db_exists=true
        fi
        
        if [ "$db_exists" = true ]; then
            echo "Info: Underlying $db_type service '$service_name' already exists. Will reuse it."
        else
            echo "Creating $db_type service '$service_name'..."
            if ! dokku "$db_type:create" "$service_name"; then
                echo "Error: Failed to create $db_type service '$service_name'."
                echo "This is required for Temporal to function. Please check the $db_type plugin installation."
                return 1
            fi
            echo "$db_type service '$service_name' created successfully."
            
            # Verify the service was actually created
            sleep 2
            if ! dokku "$db_type:info" "$service_name" >/dev/null 2>&1; then
                echo "Error: $db_type service '$service_name' was not created properly."
                return 1
            fi
        fi
    fi

    # 5. Store configuration for this Temporal service in filesystem
    debug_log "[temporal:create] Storing service configuration in filesystem"
    service_info_set "$service_name" "DB_TYPE" "$db_type"

    # Store the database service name if different from temporal service name
    if [ -n "$db_service" ]; then
        debug_log "[temporal:create] Storing custom database service name: $db_service"
        service_info_set "$service_name" "DB_SERVICE_NAME" "$db_service"
    fi

    echo ""
    echo "âœ“ Temporal service '$service_name' created successfully!"
    echo "  Database type: $db_type"
    echo "  Database service: $actual_db_service"
    echo "  Docker network: $temporal_docker_network"
    echo ""
    echo "Next steps:"
    echo "  1. Start the service: dokku temporal:start $service_name"
    echo "  2. Link to an app: dokku temporal:link $service_name <your_app>"
    echo ""
    return 0
}