#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# temporal:info <service_name>
temporal:info() {
    local service_name="$1"
    debug_log "[temporal:info] Function called with service_name='$service_name'"

    if ! validate_service_name "$service_name" "info"; then
        return 1
    fi

    # Check if the service exists in filesystem
    debug_log "[temporal:info] Checking if service '$service_name' exists in filesystem."
    if ! service_exists "$service_name"; then
        echo "Error: Temporal service '$service_name' does not exist."
        echo "Hint: Was it created with 'dokku temporal:create $service_name'?"
        return 1
    fi

    local db_type
    db_type=$(service_info_get "$service_name" "DB_TYPE")
    if [ -z "$db_type" ]; then
        echo "Error: Temporal service '$service_name' is missing DB_TYPE configuration."
        return 1
    fi
    debug_log "[temporal:info] Service '$service_name' exists with db_type='$db_type'."

    echo "Temporal Service Information:"
    echo "  Name: $service_name"
    echo "  Database Type: $db_type"

    local linked_apps
    linked_apps=$(get_linked_apps "$service_name")
    if [ -n "$linked_apps" ]; then
        echo "  Linked to Apps:"
        echo "$linked_apps" | while IFS= read -r app; do echo "    - $app"; done
    else
        echo "  Linked to Apps: None"
    fi

    echo "  Status (temporal-server-$service_name container):"
    if docker ps --filter "name=^temporal-server-${service_name}$" --format "{{.Names}}" | grep -q "^temporal-server-${service_name}$"; then
        docker ps --filter "name=^temporal-server-${service_name}$" --format "    {{.Names}}: {{.Status}} (Ports: {{.Ports}})"
    else
        echo "    temporal-server-$service_name: Not running or does not exist"
    fi

    local dokku_db_status
    dokku_db_status=$(dokku "$db_type_check":info "$service_name" --status 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$dokku_db_status" ]; then
      echo "  Dokku Datastore ($db_type_check: $service_name) Status: $dokku_db_status"
    else
      echo "  Dokku Datastore ($db_type_check: $service_name) Status: Error retrieving or unknown"
    fi

    debug_log "[temporal:info] Function finished for '$service_name'."
    return 0
}