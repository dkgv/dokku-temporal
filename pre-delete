#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# pre-delete hook: Runs when a Dokku app is being deleted
# Automatically unlinks any Temporal services from the app being destroyed

# Determine plugin path
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "$SCRIPT_DIR/functions/common"

APP="$1"

debug_log "[pre-delete] Hook triggered for app '$APP'"

# Find all services linked to this app by scanning filesystem
debug_log "[pre-delete] Checking for Temporal services linked to '$APP'"

services=$(service_list_all)

if [ -z "$services" ]; then
    debug_log "[pre-delete] No Temporal services exist"
    exit 0
fi

# Check each service to see if it's linked to this app
echo "$services" | while IFS= read -r service; do
    if [ -z "$service" ]; then
        continue
    fi

    linked_apps=$(get_linked_apps "$service")
    if echo "$linked_apps" | grep -q "^${APP}$"; then
        echo "Unlinking Temporal service '$service' from app '$APP' (app is being deleted)"

        # Remove from linked apps tracking
        remove_linked_app "$service" "$APP"

        debug_log "[pre-delete] Unlinked service '$service' from app '$APP'"
    fi
done

debug_log "[pre-delete] Hook completed for app '$APP'"
